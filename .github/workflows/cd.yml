name: ğŸš€ Continuous Deployment

on:
  workflow_run:
    workflows: ["ğŸ§ª Continuous Integration"]
    types:
      - completed
    branches: [main]
  
  # DÃ©ploiement manuel en cas de besoin
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/cesi-zen

jobs:
  # VÃ©rification des prÃ©requis
  check-prerequisites:
    name: ğŸ” Check Prerequisites
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      environment: ${{ steps.check.outputs.environment }}

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Check deployment conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Construction et publication des images Docker
  build-and-push:
    name: ğŸ—ï¸ Build & Push Images
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.should-deploy == 'true'
    
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        component: [backend, frontend]

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_BASE }}-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./cesi-zen-code/${{ matrix.component == 'backend' && 'backend-ts' || 'frontend' }}
          file: ./cesi-zen-code/${{ matrix.component == 'backend' && 'backend-ts' || 'frontend' }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # DÃ©ploiement sur staging
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [check-prerequisites, build-and-push]
    if: needs.check-prerequisites.outputs.environment == 'staging'
    
    environment:
      name: staging
      url: https://cesi-zen-staging.yourdomain.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸ§ª DÃ©ploiement vers l'environnement de staging..."
          
          # Ici vous pouvez ajouter vos commandes de dÃ©ploiement :
          # - SSH vers votre serveur de staging
          # - Mise Ã  jour des images Docker
          # - Rolling restart des services
          # - Health checks
          
          # Exemple avec docker compose sur un serveur distant :
          # ssh user@staging-server << 'EOF'
          # cd /path/to/cesi-zen
          # docker compose pull
          # docker compose up -d --force-recreate
          # EOF

      - name: ğŸ¥ Health check staging
        run: |
          echo "ğŸ¥ VÃ©rification de la santÃ© de l'application..."
          # curl -f https://cesi-zen-staging.yourdomain.com/api/health

  # Tests post-dÃ©ploiement
  post-deployment-tests:
    name: ğŸ§ª Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: needs.check-prerequisites.outputs.environment == 'staging'

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ª Run smoke tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests de fumÃ©e..."
          
          # Tests de base pour vÃ©rifier que l'application fonctionne
          # curl -f https://cesi-zen-staging.yourdomain.com/
          # curl -f https://cesi-zen-staging.yourdomain.com/api/health
          
          # Tests d'API basiques
          # curl -X POST https://cesi-zen-staging.yourdomain.com/api/auth/register \
          #   -H "Content-Type: application/json" \
          #   -d '{"email":"test@example.com","password":"test123"}'

  # DÃ©ploiement en production (nÃ©cessite approbation manuelle)
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [check-prerequisites, build-and-push]
    if: needs.check-prerequisites.outputs.environment == 'production'
    
    environment:
      name: production
      url: https://cesi-zen.yourdomain.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ DÃ©ploiement vers la production..."
          
          # Commandes de dÃ©ploiement production
          # Ces commandes sont similaires au staging mais avec plus de prÃ©cautions :
          # - Backup de la base de donnÃ©es
          # - DÃ©ploiement Blue/Green ou Rolling
          # - Monitoring renforcÃ©
          
          echo "âœ… DÃ©ploiement production terminÃ©"

      - name: ğŸ¥ Health check production
        run: |
          echo "ğŸ¥ VÃ©rification de la santÃ© de la production..."
          # curl -f https://cesi-zen.yourdomain.com/api/health

  # Notifications
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, post-deployment-tests]
    if: always() && (needs.deploy-staging.result != 'skipped' || needs.deploy-production.result != 'skipped')

    steps:
      - name: ğŸ“¢ Notify deployment status
        run: |
          if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "âœ… DÃ©ploiement staging rÃ©ussi"
          elif [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "âœ… DÃ©ploiement production rÃ©ussi"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement"
          fi
          
          # Ici vous pouvez ajouter des notifications :
          # - Slack
          # - Discord
          # - Email
          # - Teams
          
          # Exemple Slack :
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš€ CESI Zen dÃ©ployÃ© avec succÃ¨s!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # Rollback en cas de problÃ¨me
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-staging, deploy-production]
    
    environment:
      name: rollback

    steps:
      - name: ğŸ”„ Rollback deployment
        run: |
          echo "ğŸ”„ Rollback du dÃ©ploiement en cours..."
          
          # Commandes de rollback :
          # - Retour Ã  la version prÃ©cÃ©dente
          # - Restauration de la base de donnÃ©es si nÃ©cessaire
          # - VÃ©rifications post-rollback
          
          echo "âœ… Rollback terminÃ©"
